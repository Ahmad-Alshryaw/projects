---
title: "A/B Testing Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading Required Libraries

```{r}
library(dplyr)
library(rpart)
library(ggplot2)
```

## Importing Data

```{r}
user <- read.csv("user_table.csv")
test <- read.csv("test_table.csv")
```

### Check for Duplicate IDs

```{r}
length(unique(test$user_id)) == length(test$user_id) # Check duplicates in test table
length(unique(user$user_id)) == length(user$user_id) # Check duplicates in user table
```

### Check Missing IDs

```{r}
length(user$user_id) - length(test$user_id) # Check for missing IDs between tables
```

**Comment:** Some IDs are missing in the `user` table. When joining, we ensure not to lose the IDs in the `test` table.

## Merging Data

```{r}
data <- merge(test, user, by = "user_id", all.x = TRUE) # Keep all IDs in the test table
data$date <- as.Date(data$date)
summary(data)
```

## Country Conversion Analysis

### Check Conversion Rates by Country

```{r}
data_conversion_country <- data %>% 
  group_by(country) %>%
  summarize(conversion = mean(conversion[test == 0])) %>%  # Old version
  arrange(desc(conversion))

head(data_conversion_country)
```

**Comment:** Spain converts much better than the rest of LATAM countries.

## Hypothesis Testing

### Exclude Spain and Perform Proportion Test

```{r}
data_test <- subset(data, country != "Spain")
prop.test(table(data_test$conversion, data_test$test), correct = FALSE)
```

### Perform T-Test

```{r}
t.test(data_test$conversion[data_test$test == 1], data_test$conversion[data_test$test == 0])
```

**Comment:** Test users are converting at a lower rate than control users. Possible reasons include insufficient data or biases in experiment setup.

## Plot Test-Control Ratios Over Time

```{r}
data_test_by_day <- data_test %>%
  group_by(date) %>%
  summarize(test_vs_control = mean(conversion[test == 1]) / mean(conversion[test == 0]))

qplot(date, test_vs_control, data = data_test_by_day, geom = "line")
```

**Observations:** 1. Test consistently performs worse than control. 2. Experiment ran for only 5 days; longer testing is recommended to capture weekly patterns.

## Check Randomization Using Decision Tree

```{r}
head(data_test)
tree <- rpart(test ~ ., data = data_test[, -8],
              control = rpart.control(minbucket = nrow(data_test) / 100, maxdepth = 2))
tree
```

**Comment:** Randomization appears perfect for some countries but biased for others like Argentina and Uruguay.

### Country-Specific Analysis

```{r}
data_test_country <- data_test %>% 
  group_by(country) %>% 
  summarize(
    p_value = prop.test(table(conversion, test), correct = FALSE)$p.value,
    conversion_test = t.test(conversion[test == 1], conversion[test == 0])$estimate[1],
    conversion_control = t.test(conversion[test == 1], conversion[test == 0])$estimate[2]
  ) %>% 
  arrange(p_value)

data_test_country
```

**Comment:** Argentina and Uruguay show low conversion rates in both test and control groups, demonstrating Simpson's paradox.

### Remove Argentina and Uruguay, Reanalyze

```{r}
data_test <- subset(data, !(country %in% c("Spain", "Argentina", "Uruguay")))
unique(data_test$country)

# Proportion Test
prop.test(table(data_test$conversion, data_test$test), correct = FALSE)

# T-Test
 t.test(data_test$conversion[data_test$test == 1], data_test$conversion[data_test$test == 0])
```

**Conclusion:** After removing Argentina and Uruguay, the localized translation does not significantly impact conversion rates. While not a success, it confirms that the test did not negatively affect the overall performance.
